<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Second Online - Support System</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #fff; font-family: "Arial Black", sans-serif; overflow: hidden; touch-action: manipulation; text-align: center; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: #b2ebf2; padding: 10px 0; border-bottom: 2px solid #333; position: relative; }
        .logo-group { cursor: pointer; display: inline-block; }
        .logo-main { font-size: 24px; color: #000; margin: 0; line-height: 1; }
        .logo-sub { font-size: 10px; color: #000; margin: 5px 0 0 0; }
        
        /* é€šçŸ¥ãƒ™ãƒ« */
        .bell-icon { position: absolute; right: 15px; top: 10px; font-size: 28px; cursor: pointer; z-index: 110; }
        .bell-active { animation: ring 0.5s infinite; color: red; }
        @keyframes ring { 0% {transform: rotate(0);} 25% {transform: rotate(15deg);} 75% {transform: rotate(-15deg);} 100% {transform: rotate(0);} }

        /* ãŠå•ã„åˆã‚ã›ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #log-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-height: 70%; background: #fff; border-radius: 15px; border: 3px solid #333; z-index: 120; display: none; overflow-y: auto; padding: 15px; }
        .log-item { background: #f0f0f0; margin-bottom: 10px; padding: 10px; border-radius: 10px; text-align: left; font-size: 14px; border-left: 5px solid #29b6f6; }
        .log-time { font-size: 10px; color: #666; display: block; }

        /* æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»UI */
        #contact-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 350px; background: #b2f2f2; border-radius: 20px; border: 2px solid #333; z-index: 100; display: none; padding-bottom: 20px; }
        .modal-header { position: relative; padding: 15px; font-size: 18px; }
        .modal-close { position: absolute; right: 10px; top: 5px; font-size: 30px; cursor: pointer; }
        .contact-option { display: block; width: 80%; margin: 8px auto; padding: 10px; background: #a6a6a6; border: none; border-radius: 30px; font-weight: bold; }
        .contact-option.selected { background: #555; color: #fff; }
        .send-btn { width: 80%; margin-top: 15px; padding: 12px; background: #29b6f6; color: #fff; border: none; border-radius: 30px; font-weight: bold; }

        .video-container { width: 100%; aspect-ratio: 4 / 3; background: #000; position: relative; display: flex; justify-content: center; align-items: center; }
        #camera-stream { width: 100%; height: 100%; object-fit: contain; }
        #timer-display { position: absolute; top: 10px; right: 10px; background: rgba(255,0,0,0.8); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 20px; z-index: 10; display: none; }

        .info-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
        .cam-controls { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
        .camera-switch { display: flex; gap: 5px; }
        .sw-btn { padding: 8px 15px; font-weight: bold; border: none; width: 60px; opacity: 0.4; }
        .sw-btn.active { opacity: 1; outline: 2px solid #333; }
        .contact-btn { background: #29b6f6; border: none; padding: 5px 10px; font-size: 10px; font-weight: bold; width: 80px; }

        .controls { display: flex; justify-content: space-around; padding-top: 40px; }
        .move-btn { width: 110px; height: 110px; border-radius: 50%; border: 3px solid #000; background: #b2ebf2; font-size: 50px; outline: none; }
        .move-btn.active { background: #ffeb3b; }
        .move-btn.disabled { opacity: 0.1; pointer-events: none; }
        
        .sync-box { position: fixed; bottom: 5px; right: 5px; background: #eee; padding: 8px; border: 1px solid #333; font-size: 10px; z-index: 100; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo-group" onclick="checkAdminClick()">
            <h1 class="logo-main">Second Online</h1>
            <p class="logo-sub">ã‚»ã‚«ãƒ³ãƒ‰ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆ</p>
        </div>
        <div id="bell" class="bell-icon" onclick="toggleLogModal()">ğŸ””</div>
    </div>

    <div id="log-modal">
        <div class="modal-header">
            ãŠå•ã„åˆã‚ã›ä¸€è¦§
            <span class="modal-close" onclick="toggleLogModal()">Ã—</span>
        </div>
        <div id="log-container">
            <p style="font-size:12px; color:#999;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
        </div>
    </div>

    <div id="contact-modal">
        <div class="modal-header">ãŠå•ã„åˆã‚ã›<span class="modal-close" onclick="closeContact()">Ã—</span></div>
        <button class="contact-option" onclick="selectOption(this)">åˆæœŸä½ç½®</button>
        <button class="contact-option" onclick="selectOption(this)">çƒã®è£œå……</button>
        <button class="contact-option" onclick="selectOption(this)">ä¸¦è¡Œç§»å‹•</button>
        <button class="contact-option" onclick="selectOption(this)">ã‚«ãƒ¡ãƒ©ã®ä¸å…·åˆ</button>
        <button class="contact-option" onclick="selectOption(this)">ãã®ä»–</button>
        <button class="send-btn" onclick="sendContact()">é€ä¿¡</button>
    </div>

    <div class="video-container">
        <div id="timer-display">10</div>
        <img id="camera-stream" src="" alt="">
    </div>

    <div id="play-ui">
        <div class="info-bar">
            <div class="price">1Play100SP</div>
            <div class="cam-controls">
                <div class="camera-switch">
                    <button id="sw-mae" class="sw-btn active" style="background:#29b6f6;" onclick="manualSwitch('mae')">ã¾ãˆ</button>
                    <button id="sw-yoko" class="sw-btn" style="background:#bdbdbd;" onclick="manualSwitch('yoko')">ã‚ˆã“</button>
                </div>
                <button class="contact-btn" onclick="openContact()">ãŠå•ã„åˆã‚ã›</button>
            </div>
        </div>
        <div class="controls">
            <button id="btn-right" class="move-btn">â¡</button>
            <button id="btn-up" class="move-btn disabled">â¬†</button>
        </div>
    </div>

    <div id="sync-panel" class="sync-box">
        ID:<span id="my-id-status">---</span> <input type="number" id="my-set-id" style="width:30px"> <button onclick="saveAndStartPeer()">ä¿å­˜</button><br>
        ç›¸æ‰‹:<input type="number" id="target-id" style="width:30px"> <button onclick="connectToPeer()">æ¥ç¶š</button>
    </div>

    <script>
        let selectedMsg = "";
        let peer = null, conn = null, step = 1, timeLeft = 10, timerInterval = null;
        let contactLogs = [];

        // --- ãŠå•ã„åˆã‚ã›ãƒ»é€šçŸ¥ä¸€è¦§æ©Ÿèƒ½ ---
        function openContact() { document.getElementById('contact-modal').style.display = 'block'; }
        function closeContact() { document.getElementById('contact-modal').style.display = 'none'; }
        function selectOption(btn) {
            document.querySelectorAll('.contact-option').forEach(el => el.classList.remove('selected'));
            btn.classList.add('selected');
            selectedMsg = btn.innerText;
        }

        function sendContact() {
            if(!selectedMsg) return alert("å†…å®¹ã‚’é¸æŠã—ã¦ãã ã•ã„");
            sendData('CONTACT', '', selectedMsg);
            alert("é€ä¿¡å®Œäº†");
            closeContact();
        }

        function toggleLogModal() {
            const modal = document.getElementById('log-modal');
            const isVisible = modal.style.display === 'block';
            modal.style.display = isVisible ? 'none' : 'block';
            if(!isVisible) {
                document.getElementById('bell').classList.remove('bell-active');
            }
        }

        function receiveContact(msg) {
            // ãƒ­ã‚°ã«è¿½åŠ 
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            contactLogs.unshift({ time: timeStr, msg: msg });
            
            updateLogUI();
            
            // ãƒ™ãƒ«ã‚’ç‚¹æ»…ã•ã›ã‚‹
            document.getElementById('bell').classList.add('bell-active');
        }

        function updateLogUI() {
            const container = document.getElementById('log-container');
            if (contactLogs.length === 0) return;
            
            container.innerHTML = contactLogs.map(log => `
                <div class="log-item">
                    <span class="log-time">${log.time}</span>
                    <strong>${log.msg}</strong>
                </div>
            `).join('');
        }

        // --- é€šä¿¡ãƒ»ã‚¿ã‚¤ãƒãƒ¼ãƒ»ã‚«ãƒ¡ãƒ© (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯) ---
        function startTimer() {
            timeLeft = 10;
            const disp = document.getElementById('timer-display');
            disp.style.display = 'block';
            timerInterval = setInterval(() => {
                timeLeft--; disp.innerText = timeLeft;
                sendData('SYSTEM', '', 'TIMER:' + timeLeft);
                if(timeLeft <= 0) { stopTimer(); forceTransition(); }
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; document.getElementById('timer-display').style.display = 'none'; }
        function forceTransition() { if(step === 1) handleEnd.call(document.getElementById('btn-right')); }

        function setupConn() {
            conn.on('data', (data) => {
                if(data.btn === 'CONTACT') receiveContact(data.action);
                if(data.btn === 'SYSTEM' && data.action.startsWith('TIMER:')) {
                    const t = data.action.split(':')[1];
                    document.getElementById('timer-display').innerText = t;
                    document.getElementById('timer-display').style.display = t > 0 ? 'block' : 'none';
                }
                const btn = document.getElementById(data.btnId);
                if(data.action === 'PUSH' && btn) btn.classList.add('active');
                if(data.action === 'RELEASE' && btn) btn.classList.remove('active');
                if(data.cam) switchCamera(data.cam);
            });
        }

        function sendData(btn, id, action) { if(conn && conn.open) conn.send({btn: btn, btnId: id, action: action, cam: currentCam}); }

        function startPeer(id) {
            if(peer) peer.destroy();
            peer = new Peer(id);
            peer.on('open', (id) => document.getElementById('my-id-status').innerText = id);
            peer.on('connection', (c) => { conn = c; setupConn(); document.getElementById('sync-panel').classList.add('hidden'); });
        }
        function saveAndStartPeer() { const id = document.getElementById('my-set-id').value; localStorage.setItem('myCraneId', id); startPeer(id); }
        function connectToPeer() { const tid = document.getElementById('target-id').value; conn = peer.connect(tid); setupConn(); conn.on('open', () => document.getElementById('sync-panel').classList.add('hidden')); }

        let currentCam = 'mae';
        function switchCamera(target) {
            currentCam = target;
            document.getElementById('sw-mae').classList.toggle('active', target === 'mae');
            document.getElementById('sw-yoko').classList.toggle('active', target === 'yoko');
            document.getElementById('camera-stream').src = `http://${target === 'mae' ? '192.168.11.28' : '192.168.11.9'}:8080/video`;
        }
        function manualSwitch(target) { switchCamera(target); sendData('SYSTEM', '', 'SW:'+target); }

        function handleStart(e) {
            e.preventDefault(); this.classList.add('active');
            sendData(this.id==='btn-right'?'å³':'å¥¥', this.id, 'PUSH');
            if(this.id === 'btn-right' && step === 1) startTimer();
        }
        function handleEnd() {
            this.classList.remove('active');
            sendData(this.id==='btn-right'?'å³':'å¥¥', this.id, 'RELEASE');
            if(this.id === 'btn-right' && step === 1) { step = 2; document.getElementById('btn-right').classList.add('disabled'); document.getElementById('btn-up').classList.remove('disabled'); switchCamera('yoko'); }
            else if(this.id === 'btn-up' && step === 2) { step = 3; stopTimer(); document.getElementById('btn-up').classList.add('disabled'); switchCamera('mae'); setTimeout(()=>{step=1; document.getElementById('btn-right').classList.remove('disabled');}, 5000); }
        }

        [document.getElementById('btn-right'), document.getElementById('btn-up')].forEach(btn => {
            btn.addEventListener('touchstart', handleStart); btn.addEventListener('touchend', handleEnd);
        });

        window.onload = () => {
            const sid = localStorage.getItem('myCraneId');
            if(sid) { document.getElementById('my-set-id').value = sid; startPeer(sid); }
            switchCamera('mae');
        };
    </script>
</body>
</html>
